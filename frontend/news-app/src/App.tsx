import React, { useState, useEffect, useRef } from 'react';
import {
  Typography,
  Box,
  TextField,
  Select,
  MenuItem,
  FormControl,
  InputLabel,
  Alert,
  CircularProgress,
  Paper,
  Chip,
  Card,
  CardContent,
  Stack,
  Divider,
  Button,
  Tabs,
  Tab,
  IconButton,
  Grid,
  Container,
  AppBar,
  Toolbar,
  Drawer,
  Switch,
  FormControlLabel,
  List,
  ListItem,
  ListItemText,
  ListItemIcon,
  Pagination,
  Tooltip,
  Badge,
} from '@mui/material';
import {
  Article as ArticleIcon,
  Favorite,
  FavoriteBorder,
  Analytics,
  Cloud,
  Search,
  Refresh,
  FilterList,
  TrendingUp,
  OpenInNew,
  DarkMode,
  LightMode,
  AccessTime,
  Keyboard,
  Visibility,
} from '@mui/icons-material';
import { ThemeProvider } from '@mui/material/styles';
import CssBaseline from '@mui/material/CssBaseline';

import { newsApi } from './api/newsApi';
import type { Article, KeywordStats } from './api/newsApi';
import { KeywordCloud } from './components/KeywordCloud';
import { KeywordNetwork } from './components/KeywordNetwork';
import { ColorPalette } from './components/ColorPalette';
import { useThemeProvider } from './hooks/useTheme';
import { useKeyboardShortcuts } from './hooks/useKeyboardShortcuts';
import { calculateReadingTime, formatReadingTime } from './utils/readingTime';


interface TabPanelProps {
  children?: React.ReactNode;
  index: number;
  value: number;
}

function TabPanel(props: TabPanelProps) {
  const { children, value, index } = props;
  return (
    <div role="tabpanel" hidden={value !== index}>
      {value === index && <Box sx={{ p: 3 }}>{children}</Box>}
    </div>
  );
}

// Í∞úÎ≥Ñ Í∏∞ÏÇ¨ Ïπ¥Îìú Ïª¥Ìè¨ÎÑåÌä∏ (Í∞úÏÑ†Îêú ÎîîÏûêÏù∏)
interface ArticleCardProps {
  article: Article;
  onToggleFavorite: (id: number) => void;
  onExtractKeywords?: (id: number) => void;
  onTranslate?: (id: number) => void;
}

// ÌÇ§ÏõåÎìú ÎÑ§Ìä∏ÏõåÌÅ¨ Ïª®ÌÖåÏù¥ÎÑà Ïª¥Ìè¨ÎÑåÌä∏
function KeywordNetworkContainer() {
  const [networkData, setNetworkData] = useState<any>({ nodes: [], edges: [] });
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const loadNetworkData = async () => {
      try {
        const data = await newsApi.getKeywordNetwork();
        setNetworkData(data);
      } catch (error) {
        console.error('Failed to load network data:', error);
      } finally {
        setLoading(false);
      }
    };

    loadNetworkData();
  }, []);

  if (loading) {
    return (
      <Box sx={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height: 400 }}>
        <CircularProgress />
      </Box>
    );
  }

  return <KeywordNetwork data={networkData} />;
}

function ArticleCard({ article, onToggleFavorite, onExtractKeywords, onTranslate }: ArticleCardProps) {
  const readingTime = calculateReadingTime((article.title || '') + (article.summary || ''));
  
  return (
    <Card sx={{ 
      mb: 2.5, 
      transition: 'all 0.3s ease-in-out', 
      '&:hover': { 
        transform: 'translateY(-2px)',
        boxShadow: '0 8px 25px rgba(0, 0, 0, 0.15)'
      },
      borderRadius: 3,
      overflow: 'hidden'
    }}>
      <CardContent sx={{ p: 3 }}>
        <Grid container spacing={2}>
          <Grid item xs={12} sm={11}>
            <Box sx={{ display: 'flex', alignItems: 'flex-start', gap: 1.5, mb: 2 }}>
              <Box sx={{ flex: 1 }}>
                <Typography variant="h6" sx={{ 
                  fontWeight: 700, 
                  mb: 1.5,
                  lineHeight: 1.4,
                  fontSize: { xs: '1.05rem', md: '1.15rem' }
                }}>
                  <a href={article.link} target="_blank" rel="noopener noreferrer" 
                     style={{ 
                       textDecoration: 'none', 
                       color: 'inherit'
                     }}>
                    {article.title}
                    <OpenInNew fontSize="small" sx={{ ml: 1, verticalAlign: 'middle', opacity: 0.7 }} />
                  </a>
                </Typography>
              </Box>
            </Box>
            
            <Stack direction="row" spacing={{ xs: 1, md: 2 }} sx={{ mb: 2, flexWrap: 'wrap', gap: 1 }}>
              <Chip
                icon={<ArticleIcon fontSize="small" />}
                label={article.source}
                variant="outlined"
                size="small"
                color="primary"
              />
              <Chip
                icon={<AccessTime fontSize="small" />}
                label={new Date(article.published).toLocaleDateString('ko-KR')}
                variant="outlined"
                size="small"
              />
              <Chip
                icon={<Visibility fontSize="small" />}
                label={formatReadingTime(readingTime)}
                variant="outlined"
                size="small"
                color="secondary"
              />
            </Stack>

            {article.summary && (
              <Typography variant="body1" sx={{ 
                mb: 2, 
                lineHeight: 1.7,
                color: 'text.secondary',
                fontSize: '0.95rem'
              }}>
                {article.summary.length > 200 
                  ? `${article.summary.substring(0, 200)}...` 
                  : article.summary}
              </Typography>
            )}

            {article.keywords && (
              <Box sx={{ mt: 2 }}>
                <Typography variant="body2" component="div" sx={{ mb: 1, fontWeight: 600 }}>
                  üè∑Ô∏è ÌÇ§ÏõåÎìú
                </Typography>
                <Box sx={{ display: 'flex', flexWrap: 'wrap', gap: 0.5 }}>
                  {typeof article.keywords === 'string' 
                    ? article.keywords.split(',').slice(0, 8).map((keyword: string, index: number) => (
                        <Chip 
                          key={index} 
                          label={keyword.trim()} 
                          size="small"
                          variant="outlined"
                          sx={{ 
                            fontSize: '0.75rem',
                            height: 24,
                            borderRadius: 3,
                            '&:hover': {
                              backgroundColor: 'primary.main',
                              color: 'primary.contrastText',
                              borderColor: 'primary.main'
                            }
                          }} 
                        />
                      ))
                    : Array.isArray(article.keywords) 
                      ? article.keywords.slice(0, 8).map((keyword: string, index: number) => (
                          <Chip 
                            key={index} 
                            label={keyword} 
                            size="small"
                            variant="outlined"
                            sx={{ 
                              fontSize: '0.75rem',
                              height: 24,
                              borderRadius: 3,
                              '&:hover': {
                                backgroundColor: 'primary.main',
                                color: 'primary.contrastText',
                                borderColor: 'primary.main'
                              }
                            }} 
                          />
                        ))
                      : null
                  }
                </Box>
              </Box>
            )}
          </Grid>
          
          <Grid item xs={12} sm={1} sx={{ display: 'flex', justifyContent: { xs: 'flex-end', sm: 'center' } }}>
            <Stack spacing={1} alignItems="center">
              <Tooltip title={article.is_favorite ? 'Ï¶êÍ≤®Ï∞æÍ∏∞ Ìï¥Ï†ú' : 'Ï¶êÍ≤®Ï∞æÍ∏∞ Ï∂îÍ∞Ä'}>
                <IconButton 
                  onClick={() => onToggleFavorite(article.id)}
                  color={article.is_favorite ? "secondary" : "default"}
                  sx={{
                    transition: 'all 0.2s',
                    '&:hover': {
                      transform: 'scale(1.1)'
                    }
                  }}
                >
                  {article.is_favorite ? <Favorite /> : <FavoriteBorder />}
                </IconButton>
              </Tooltip>
              {onExtractKeywords && (
                <Tooltip title="ÌÇ§ÏõåÎìú Ï∂îÏ∂ú">
                  <IconButton 
                    onClick={() => onExtractKeywords(article.id)}
                    size="small"
                  >
                    <TrendingUp fontSize="small" />
                  </IconButton>
                </Tooltip>
              )}
              {onTranslate && (
                <Tooltip title="Î≤àÏó≠">
                  <IconButton 
                    onClick={() => onTranslate(article.id)}
                    size="small"
                  >
                    üåê
                  </IconButton>
                </Tooltip>
              )}
              <Typography variant="caption" color="text.secondary">
                #{article.id}
              </Typography>
            </Stack>
          </Grid>
        </Grid>
      </CardContent>
    </Card>
  );
}

// ÌÇ§Î≥¥Îìú Îã®Ï∂ïÌÇ§ ÎèÑÏõÄÎßê Ïª¥Ìè¨ÎÑåÌä∏
function KeyboardShortcutsHelp() {
  return (
    <Paper sx={{ p: 2, mb: 2, bgcolor: 'action.hover' }}>
      <Typography variant="body2" sx={{ mb: 1, fontWeight: 600 }}>
        ‚å®Ô∏è ÌÇ§Î≥¥Îìú Îã®Ï∂ïÌÇ§
      </Typography>
      <Stack spacing={0.5}>
        <Typography variant="body2">‚Ä¢ Ctrl/Cmd + R: Îâ¥Ïä§ ÏÉàÎ°úÍ≥†Ïπ®</Typography>
        <Typography variant="body2">‚Ä¢ Ctrl/Cmd + D: Îã§ÌÅ¨Î™®Îìú ÌÜ†Í∏Ä</Typography>
        <Typography variant="body2">‚Ä¢ Ctrl/Cmd + K: Í≤ÄÏÉâ Ìè¨Ïª§Ïä§</Typography>
        <Typography variant="body2">‚Ä¢ Ctrl/Cmd + ‚Üê/‚Üí: ÌÉ≠ Ï†ÑÌôò</Typography>
      </Stack>
    </Paper>
  );
}

// Î©îÏù∏ App Ïª¥Ìè¨ÎÑåÌä∏
export default function App() {
  const { isDarkMode, toggleTheme, theme, colors, ThemeContext } = useThemeProvider();
  const [tabValue, setTabValue] = useState(0);
  const searchInputRef = useRef<HTMLInputElement>(null);
  const [articles, setArticles] = useState<Article[]>([]);
  const [filteredArticles, setFilteredArticles] = useState<Article[]>([]);
  const [keywordStats, setKeywordStats] = useState<KeywordStats[]>([]);
  const [loading, setLoading] = useState(false);
  const [collecting, setCollecting] = useState(false);
  const [collections, setCollections] = useState<any[]>([]);
  
  // ÌïÑÌÑ∞ ÏÉÅÌÉú
  const [searchTerm, setSearchTerm] = useState('');
  const [selectedSource, setSelectedSource] = useState('all');
  const [dateFrom, setDateFrom] = useState(() => {
    const date = new Date();
    date.setDate(date.getDate() - 7);
    return date.toISOString().split('T')[0];
  });
  const [dateTo, setDateTo] = useState(() => new Date().toISOString().split('T')[0]);
  const [favoritesOnly, setFavoritesOnly] = useState(false);
  
  // ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò
  const [currentPage, setCurrentPage] = useState(1);
  const itemsPerPage = 10;
  
  // ÏÇ¨Ïù¥ÎìúÎ∞î - Îç∞Ïä§ÌÅ¨ÌÜ±ÏóêÏÑúÎäî Ìï≠ÏÉÅ Í≥†Ï†ï
  const [drawerOpen, setDrawerOpen] = useState(true);
  const [showShortcutsHelp] = useState(false);
  const [isDesktop, setIsDesktop] = useState(window.innerWidth >= 1024);

  // ÌôîÎ©¥ ÌÅ¨Í∏∞ Í∞êÏßÄ
  useEffect(() => {
    const handleResize = () => {
      const desktop = window.innerWidth >= 1024;
      setIsDesktop(desktop);
      // Îç∞Ïä§ÌÅ¨ÌÜ±ÏóêÏÑúÎäî ÏÇ¨Ïù¥ÎìúÎ∞î Ìï≠ÏÉÅ Ïó¥Í∏∞, Î™®Î∞îÏùºÏóêÏÑúÎäî Í∏∞Î≥∏ÏúºÎ°ú Îã´Í∏∞
      if (desktop && !drawerOpen) {
        setDrawerOpen(true);
      } else if (!desktop && drawerOpen) {
        setDrawerOpen(false);
      }
    };

    window.addEventListener('resize', handleResize);
    handleResize(); // Ï¥àÍ∏∞ Ïã§Ìñâ

    return () => window.removeEventListener('resize', handleResize);
  }, [drawerOpen]);

  // Ï¥àÍ∏∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
  useEffect(() => {
    const loadInitialData = async () => {
      setLoading(true);
      try {
        const articlesData = await newsApi.getArticles({ limit: 100 });
        setArticles(articlesData);
        const keywordStatsData = await newsApi.getKeywordStats();
        setKeywordStats(keywordStatsData);
        const collectionsData = await newsApi.getCollections();
        setCollections(collectionsData);
      } catch (error) {
        console.error('Failed to load initial data:', error);
      } finally {
        setLoading(false);
      }
    };

    loadInitialData();
  }, []);

  // ÌïÑÌÑ∞ Ï†ÅÏö©
  useEffect(() => {
    let filtered = [...articles];

    if (searchTerm) {
      const searchLower = searchTerm.toLowerCase();
      filtered = filtered.filter(article => 
        article.title?.toLowerCase().includes(searchLower) ||
        article.summary?.toLowerCase().includes(searchLower) ||
        (typeof article.keywords === 'string' 
          ? article.keywords.toLowerCase().includes(searchLower)
          : Array.isArray(article.keywords) 
            ? article.keywords.some(k => k.toLowerCase().includes(searchLower))
            : false)
      );
    }

    if (selectedSource && selectedSource !== 'all') {
      filtered = filtered.filter(article => article.source === selectedSource);
    }

    if (dateFrom) {
      filtered = filtered.filter(article => 
        new Date(article.published) >= new Date(dateFrom)
      );
    }

    if (dateTo) {
      filtered = filtered.filter(article => 
        new Date(article.published) <= new Date(dateTo)
      );
    }

    if (favoritesOnly) {
      filtered = filtered.filter(article => article.is_favorite);
    }

    // Sort by published date (newest first)
    filtered.sort((a, b) => 
      new Date(b.published).getTime() - new Date(a.published).getTime()
    );

    setFilteredArticles(filtered);
    setCurrentPage(1);
  }, [articles, searchTerm, selectedSource, dateFrom, dateTo, favoritesOnly]);

  // Enhanced news collection with improved error handling
  const collectNews = async () => {
    setCollecting(true);
    
    try {
      console.log('üöÄ Starting news collection...');
      
      // Use the immediate collection API for better user feedback
      const collectionResult = await newsApi.collectNewsNow();
      
      console.log('‚úÖ Collection completed:', collectionResult);
      
      if (collectionResult && collectionResult.status === 'success') {
        // Show success message with details
        const inserted = collectionResult.inserted || 0;
        const updated = collectionResult.updated || 0;
        const total = collectionResult.total_articles || 0;
        const duration = collectionResult.duration ? ` (${Math.round(collectionResult.duration)}Ï¥à)` : '';
        
        const message = `‚úÖ Îâ¥Ïä§ ÏàòÏßë ÏôÑÎ£å${duration}\n` +
          `‚Ä¢ Ïã†Í∑ú: ${inserted}Í∞ú\n` + 
          `‚Ä¢ ÏóÖÎç∞Ïù¥Ìä∏: ${updated}Í∞ú\n` +
          `‚Ä¢ Ï†ÑÏ≤¥ Í∏∞ÏÇ¨: ${total}Í∞ú`;
        
        alert(message);
        
        // Reload data with error handling for each request
        try {
          console.log('üì∞ Reloading articles...');
          const articlesData = await newsApi.getArticles({ limit: 100 });
          setArticles(articlesData);
          console.log(`‚úÖ Loaded ${articlesData.length} articles`);
        } catch (articlesError) {
          console.error('Failed to reload articles:', articlesError);
        }
        
        try {
          console.log('üîç Reloading keyword stats...');
          const keywordStatsData = await newsApi.getKeywordStats();
          setKeywordStats(keywordStatsData);
          console.log(`‚úÖ Loaded ${keywordStatsData.length} keywords`);
        } catch (keywordsError) {
          console.error('Failed to reload keywords:', keywordsError);
        }
        
        // Update collections if they exist
        try {
          console.log('üìÅ Reloading collections...');
          const collectionsData = await newsApi.getCollections();
          setCollections(collectionsData);
          console.log(`‚úÖ Loaded ${collectionsData.length} collections`);
        } catch (collectionsError) {
          console.warn('Collections not available:', collectionsError);
          // This is not critical, so don't show error to user
        }
        
      } else if (collectionResult) {
        console.error('Collection failed:', collectionResult);
        const errorMsg = collectionResult.message || 
          `Îâ¥Ïä§ ÏàòÏßëÏù¥ Ïã§Ìå®ÌñàÏäµÎãàÎã§. ÏÉÅÌÉú: ${collectionResult.status || 'unknown'}`;
        alert(`‚ùå ${errorMsg}`);
      } else {
        throw new Error('No response from collection API');
      }
      
    } catch (error) {
      console.error('Failed to collect news:', error);
      
      // More specific error messages
      let errorMessage = 'Îâ¥Ïä§ ÏàòÏßë Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.';
      
      if (error instanceof Error) {
        if (error.message.includes('fetch')) {
          errorMessage += '\nÎÑ§Ìä∏ÏõåÌÅ¨ Ïó∞Í≤∞ÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.';
        } else if (error.message.includes('timeout')) {
          errorMessage += '\nÏöîÏ≤≠ ÏãúÍ∞ÑÏù¥ Ï¥àÍ≥ºÎêòÏóàÏäµÎãàÎã§.';
        } else {
          errorMessage += `\nÏò§Î•ò ÎÇ¥Ïö©: ${error.message}`;
        }
      }
      
      errorMessage += '\n\nÎã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.';
      alert(`‚ùå ${errorMessage}`);
      
    } finally {
      setCollecting(false);
      console.log('üìù Collection process finished');
    }
  };

  // Ï¶êÍ≤®Ï∞æÍ∏∞ ÌÜ†Í∏Ä
  const handleToggleFavorite = async (articleId: number) => {
    try {
      const article = articles.find(a => a.id === articleId);
      if (!article) return;

      if (article.is_favorite) {
        await newsApi.removeFavorite(articleId);
      } else {
        await newsApi.addFavorite(articleId);
      }

      // Î°úÏª¨ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
      setArticles(prev => prev.map(a => 
        a.id === articleId ? { ...a, is_favorite: !a.is_favorite } : a
      ));
    } catch (error) {
      console.error('Failed to toggle favorite:', error);
    }
  };

  // Ïª¨Î†âÏÖò ÏÉùÏÑ±
  const handleCreateCollection = async () => {
    const name = prompt('ÏÉà Ïª¨Î†âÏÖò Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:');
    if (!name) return;
    
    const keywords = prompt('Í¥ÄÎ†® ÌÇ§ÏõåÎìúÎ•º ÏâºÌëúÎ°ú Íµ¨Î∂ÑÌïòÏó¨ ÏûÖÎ†•ÌïòÏÑ∏Ïöî (Ïòà: AI, ÌÅ¥ÎùºÏö∞Îìú, Î≥¥Ïïà):');
    const rules = keywords ? { include_keywords: keywords.split(',').map(k => k.trim()) } : {};
    
    try {
      await newsApi.createCollection(name, rules);
      const updatedCollections = await newsApi.getCollections();
      setCollections(updatedCollections);
      alert(`Ïª¨Î†âÏÖò '${name}'Ïù¥ ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!`);
    } catch (error) {
      console.error('Failed to create collection:', error);
      alert('Ïª¨Î†âÏÖò ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
    }
  };

  // ÌÇ§ÏõåÎìú Ï∂îÏ∂ú
  const handleExtractKeywords = async (articleId: number) => {
    try {
      const result = await newsApi.extractKeywords(articleId);
      // Update the article with new keywords
      setArticles(prev => prev.map(a => 
        a.id === articleId ? { ...a, keywords: result.keywords } : a
      ));
      alert('ÌÇ§ÏõåÎìú Ï∂îÏ∂úÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!');
    } catch (error) {
      console.error('Failed to extract keywords:', error);
    }
  };

  // Î≤àÏó≠
  const handleTranslate = async (articleId: number) => {
    try {
      const result = await newsApi.translateArticle(articleId);
      alert(result.message);
      if (result.article.is_translated) {
        // Update article with translation
        setArticles(prev => prev.map(a => 
          a.id === articleId ? { 
            ...a, 
            title: result.article.translated_title || a.title,
            summary: result.article.translated_summary || a.summary 
          } : a
        ));
      }
    } catch (error) {
      console.error('Failed to translate article:', error);
    }
  };

  // ÌÉ≠ Î≥ÄÍ≤Ω
  const handleTabChange = (_: React.SyntheticEvent, newValue: number) => {
    setTabValue(newValue);
  };


  // ÌÇ§Î≥¥Îìú Îã®Ï∂ïÌÇ§ ÏÑ§Ï†ï
  useKeyboardShortcuts({
    onRefresh: collectNews,
    onToggleTheme: toggleTheme,
    onSearch: () => searchInputRef.current?.focus(),
    onNextTab: () => setTabValue(prev => (prev + 1) % 5),
    onPrevTab: () => setTabValue(prev => (prev - 1 + 5) % 5),
  });

  // ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò Í≥ÑÏÇ∞
  const totalPages = Math.ceil(filteredArticles.length / itemsPerPage);
  const currentArticles = filteredArticles.slice(
    (currentPage - 1) * itemsPerPage,
    currentPage * itemsPerPage
  );

  // ÏÜåÏä§ Î™©Î°ù (articlesÏóêÏÑú Ï∂îÏ∂ú)
  const sources = [...new Set(articles.map(a => a.source))].sort();
  
  // ÌÜµÍ≥Ñ (ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Í≥ÑÏÇ∞)
  const stats = {
    totalArticles: articles.length,
    totalSources: sources.length,
    totalFavorites: articles.filter(a => a.is_favorite).length,
    recentArticles: articles.filter(a => {
      const weekAgo = new Date();
      weekAgo.setDate(weekAgo.getDate() - 7);
      return new Date(a.published) >= weekAgo;
    }).length
  };

  return (
    <ThemeContext.Provider value={{ isDarkMode, toggleTheme, theme, colors }}>
      <ThemeProvider theme={theme}>
        <CssBaseline />
      
      {/* ÏÉÅÎã® Ïï±Î∞î */}
      <AppBar position="fixed" sx={{ zIndex: theme => theme.zIndex.drawer + 1 }}>
        <Toolbar>
          <Typography variant="h5" component="div" sx={{ flexGrow: 1, fontWeight: 'bold' }}>
            üóûÔ∏è Îâ¥Ïä§ÏûàÏäà~(News IT's Issue)
          </Typography>
          
          <Stack direction="row" spacing={1} sx={{ display: { xs: 'none', sm: 'flex' } }}>
            <Tooltip title={isDarkMode ? 'ÎùºÏù¥Ìä∏ Î™®Îìú' : 'Îã§ÌÅ¨ Î™®Îìú'}>
              <IconButton color="inherit" onClick={toggleTheme}>
                {isDarkMode ? <LightMode /> : <DarkMode />}
              </IconButton>
            </Tooltip>
            
            <Tooltip title="ÏÉàÎ°úÍ≥†Ïπ®">
              <IconButton 
                color="inherit" 
                onClick={collectNews}
                disabled={collecting}
              >
                <Refresh />
              </IconButton>
            </Tooltip>
            
            <Tooltip title={isDesktop ? "ÏÇ¨Ïù¥ÎìúÎ∞î ÌÜ†Í∏Ä" : "ÌïÑÌÑ∞ Î©îÎâ¥"}>
              <IconButton color="inherit" onClick={() => setDrawerOpen(!drawerOpen)}>
                <FilterList />
              </IconButton>
            </Tooltip>
          </Stack>
          
          {/* Î™®Î∞îÏùºÏö© Ï∂ïÏïΩ Î≤ÑÌäº */}
          <Stack direction="row" spacing={1} sx={{ display: { xs: 'flex', sm: 'none' } }}>
            <Tooltip title={isDarkMode ? 'ÎùºÏù¥Ìä∏ Î™®Îìú' : 'Îã§ÌÅ¨ Î™®Îìú'}>
              <IconButton color="inherit" onClick={toggleTheme}>
                {isDarkMode ? <LightMode /> : <DarkMode />}
              </IconButton>
            </Tooltip>
            
            <Tooltip title="ÏÉàÎ°úÍ≥†Ïπ®">
              <IconButton 
                color="inherit" 
                onClick={collectNews}
                disabled={collecting}
              >
                <Refresh />
              </IconButton>
            </Tooltip>
            
            <Tooltip title="ÌïÑÌÑ∞ Î©îÎâ¥">
              <IconButton color="inherit" onClick={() => setDrawerOpen(!drawerOpen)}>
                <FilterList />
              </IconButton>
            </Tooltip>
          </Stack>
        </Toolbar>
      </AppBar>
      
      {/* ÏÇ¨Ïù¥ÎìúÎ∞î (ÌïÑÌÑ∞) */}
      <Drawer
        variant={isDesktop ? "persistent" : "temporary"}
        open={drawerOpen}
        onClose={() => !isDesktop && setDrawerOpen(false)}
        sx={{
          width: 300,
          flexShrink: 0,
          '& .MuiDrawer-paper': { 
            width: 300, 
            boxSizing: 'border-box', 
            pt: 8,
            ...(isDesktop && {
              position: 'fixed',
              height: '100vh',
            })
          },
        }}
      >
        <Box sx={{ p: 2 }}>
          {showShortcutsHelp && <KeyboardShortcutsHelp />}
          
          <Typography variant="h6" gutterBottom>üîß ÌïÑÌÑ∞ÎßÅ</Typography>
          
          {/* Îâ¥Ïä§ ÏÜåÏä§ */}
          <FormControl fullWidth sx={{ mb: 2 }}>
            <InputLabel>Îâ¥Ïä§ ÏÜåÏä§</InputLabel>
            <Select
              value={selectedSource}
              onChange={(e) => setSelectedSource(e.target.value)}
              label="Îâ¥Ïä§ ÏÜåÏä§"
            >
              <MenuItem value="all">Ï†ÑÏ≤¥</MenuItem>
              {sources.map(source => (
                <MenuItem key={source} value={source}>{source}</MenuItem>
              ))}
            </Select>
          </FormControl>

          {/* ÌÇ§ÏõåÎìú Í≤ÄÏÉâ */}
          <TextField
            fullWidth
            inputRef={searchInputRef}
            label="ÌÇ§ÏõåÎìú Í≤ÄÏÉâ"
            placeholder="Ïòà: AI, Î∞òÎèÑÏ≤¥, 5G (Ctrl+K)"
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            sx={{ mb: 2 }}
            InputProps={{
              startAdornment: <Search sx={{ mr: 1, color: 'text.secondary' }} />
            }}
          />

          {/* Í∏∞Í∞Ñ ÌïÑÌÑ∞ */}
          <TextField
            fullWidth
            type="date"
            label="ÏãúÏûëÏùº"
            value={dateFrom}
            onChange={(e) => setDateFrom(e.target.value)}
            sx={{ mb: 2 }}
            InputLabelProps={{ shrink: true }}
          />
          
          <TextField
            fullWidth
            type="date"
            label="Ï¢ÖÎ£åÏùº"
            value={dateTo}
            onChange={(e) => setDateTo(e.target.value)}
            sx={{ mb: 2 }}
            InputLabelProps={{ shrink: true }}
          />

          {/* Ï¶êÍ≤®Ï∞æÍ∏∞Îßå Î≥¥Í∏∞ */}
          <FormControlLabel
            control={
              <Switch
                checked={favoritesOnly}
                onChange={(e) => setFavoritesOnly(e.target.checked)}
              />
            }
            label="Ï¶êÍ≤®Ï∞æÍ∏∞Îßå Î≥¥Í∏∞"
            sx={{ mb: 2 }}
          />

          <Divider sx={{ my: 2 }} />
          
          {/* Îç∞Ïù¥ÌÑ∞ Í¥ÄÎ¶¨ */}
          <Typography variant="h6" gutterBottom>üìä Îç∞Ïù¥ÌÑ∞ Í¥ÄÎ¶¨</Typography>
          
          <Button
            variant="contained"
            fullWidth
            startIcon={collecting ? <CircularProgress size={20} /> : <Refresh />}
            onClick={collectNews}
            disabled={collecting}
            sx={{ mb: 2 }}
          >
            {collecting ? 'ÏàòÏßë Ï§ë...' : 'üîÑ Îâ¥Ïä§ ÏàòÏßë'}
          </Button>

          {/* Ïª¨Î†âÏÖò Í¥ÄÎ¶¨ Î≤ÑÌäº Ï∂îÍ∞Ä */}
          <Button
            variant="outlined"
            fullWidth
            onClick={() => handleCreateCollection()}
            sx={{ mb: 2 }}
          >
            üìÅ ÏÉà Ïª¨Î†âÏÖò ÎßåÎì§Í∏∞
          </Button>

          {/* ÌÜµÍ≥Ñ */}
          <Paper sx={{ 
            p: 2, 
            bgcolor: theme => theme.palette.mode === 'dark' ? 'grey.800' : 'grey.50',
            border: theme => theme.palette.mode === 'dark' ? '1px solid rgba(255, 255, 255, 0.12)' : 'none',
            mb: 2
          }}>
            <Typography variant="body2" sx={{ 
              color: theme => theme.palette.mode === 'dark' ? 'grey.300' : 'text.primary'
            }}>
              üìä Ï¥ù {stats.totalArticles}Í±¥Ïùò Îâ¥Ïä§<br/>
              üì∞ {stats.totalSources}Í∞ú ÏÜåÏä§<br/>
              ‚≠ê {stats.totalFavorites}Í∞ú Ï¶êÍ≤®Ï∞æÍ∏∞<br/>
              üìÖ ÏµúÍ∑º 7Ïùº: {stats.recentArticles}Í±¥
            </Typography>
          </Paper>

          {/* Ïª¨Î†âÏÖò Î™©Î°ù */}
          {collections.length > 0 && (
            <>
              <Divider sx={{ my: 2 }} />
              <Typography variant="h6" gutterBottom>üìÅ Ïª¨Î†âÏÖò</Typography>
              <Stack spacing={1}>
                {collections.map((collection, index) => (
                  <Chip
                    key={index}
                    label={`${collection.name} (${collection.count})`}
                    variant="outlined"
                    size="small"
                  />
                ))}
              </Stack>
            </>
          )}
        </Box>
      </Drawer>

      {/* Î©îÏù∏ Ïª®ÌÖêÏ∏† */}
      <Box sx={{ 
        flexGrow: 1, 
        p: { xs: 2, md: 3 }, 
        pt: { xs: 10, md: 12 },
        ml: (isDesktop && drawerOpen) ? '300px' : 0,
        transition: 'margin-left 0.3s',
        minHeight: '100vh'
      }}>
        <Typography variant="body1" sx={{ mb: 2, color: 'text.secondary' }}>
          **IT/Í≥µÌïô Îâ¥Ïä§ ÏàòÏßë, Î∂ÑÏÑù, ÏãúÍ∞ÅÌôî ÎåÄÏãúÎ≥¥Îìú**
        </Typography>

        {/* ÌÉ≠ */}
        <Box sx={{ borderBottom: 1, borderColor: 'divider', mb: 2 }}>
          <Tabs 
            value={tabValue} 
            onChange={handleTabChange}
            variant={isDesktop ? "standard" : "scrollable"}
            scrollButtons={isDesktop ? false : "auto"}
            sx={{
              '& .MuiTab-root': {
                minWidth: isDesktop ? 120 : 80,
                fontSize: { xs: '0.8rem', md: '0.875rem' }
              }
            }}
          >
            <Tab icon={<ArticleIcon />} label={isDesktop ? "üì∞ Îâ¥Ïä§ Î™©Î°ù" : "Îâ¥Ïä§"} />
            <Tab icon={<Analytics />} label={isDesktop ? "üìä ÌÇ§ÏõåÎìú Î∂ÑÏÑù" : "Î∂ÑÏÑù"} />
            <Tab icon={<Cloud />} label={isDesktop ? "‚òÅÔ∏è ÏõåÎìúÌÅ¥ÎùºÏö∞Îìú" : "ÏõåÎìúÌÅ¥ÎùºÏö∞Îìú"} />
            <Tab icon={<Favorite />} label={isDesktop ? "‚≠ê Ï¶êÍ≤®Ï∞æÍ∏∞" : "Ï¶êÍ≤®Ï∞æÍ∏∞"} />
            <Tab icon={<DarkMode />} label={isDesktop ? "üé® ÌÖåÎßà/Ïª¨Îü¨" : "ÌÖåÎßà"} />
          </Tabs>
        </Box>

        {loading && (
          <Box sx={{ display: 'flex', justifyContent: 'center', p: 4 }}>
            <CircularProgress />
          </Box>
        )}

        {/* Îâ¥Ïä§ Î™©Î°ù ÌÉ≠ */}
        <TabPanel value={tabValue} index={0}>
          <Typography variant="h5" gutterBottom>üì∞ Îâ¥Ïä§ Î™©Î°ù</Typography>
          <Typography variant="body1" sx={{ mb: 2, fontWeight: 'bold' }}>
            **Ï¥ù {filteredArticles.length}Í±¥Ïùò Îâ¥Ïä§**
          </Typography>

          {filteredArticles.length === 0 ? (
            <Alert severity="info">
              {articles.length === 0 ? 
                'Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§. ÏÇ¨Ïù¥ÎìúÎ∞îÏóêÏÑú "Îâ¥Ïä§ ÏàòÏßë" Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ Îç∞Ïù¥ÌÑ∞Î•º ÏàòÏßëÌïòÏÑ∏Ïöî.' :
                'ÌïÑÌÑ∞ Ï°∞Í±¥Ïóê ÎßûÎäî Îâ¥Ïä§Í∞Ä ÏóÜÏäµÎãàÎã§.'
              }
            </Alert>
          ) : (
            <>
              {currentArticles.map(article => (
                <ArticleCard
                  key={article.id}
                  article={article}
                  onToggleFavorite={handleToggleFavorite}
                  onExtractKeywords={handleExtractKeywords}
                  onTranslate={handleTranslate}
                />
              ))}
              
              {totalPages > 1 && (
                <Box sx={{ display: 'flex', justifyContent: 'center', mt: 3 }}>
                  <Pagination
                    count={totalPages}
                    page={currentPage}
                    onChange={(_, page) => setCurrentPage(page)}
                    color="primary"
                  />
                </Box>
              )}
            </>
          )}
        </TabPanel>

        {/* ÌÇ§ÏõåÎìú Î∂ÑÏÑù ÌÉ≠ */}
        <TabPanel value={tabValue} index={1}>
          <Typography variant="h5" gutterBottom>üìä ÌÇ§ÏõåÎìú ÎÑ§Ìä∏ÏõåÌÅ¨ Î∂ÑÏÑù</Typography>
          
          {keywordStats.length === 0 ? (
            <Alert severity="info">Î∂ÑÏÑùÌï† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</Alert>
          ) : (
            <Grid container spacing={3}>
              <Grid item xs={12} md={6}>
                <Typography variant="h6" gutterBottom>üî• Ïù∏Í∏∞ ÌÇ§ÏõåÎìú TOP 20</Typography>
                <Paper sx={{ p: 2, maxHeight: 400, overflow: 'auto' }}>
                  <List dense>
                    {keywordStats.slice(0, 20).map((stat, index) => (
                      <ListItem key={stat.keyword}>
                        <ListItemText
                          primary={`${index + 1}. ${stat.keyword}`}
                          secondary={`${stat.count}Ìöå`}
                        />
                      </ListItem>
                    ))}
                  </List>
                </Paper>
              </Grid>
              
              <Grid item xs={12} md={6}>
                <Typography variant="h6" gutterBottom>üìà ÌÇ§ÏõåÎìú Î∂ÑÌè¨</Typography>
                <Paper sx={{ p: 2, height: 400 }}>
                  {keywordStats.length > 0 && (
                    <KeywordCloud keywords={keywordStats.slice(0, 50)} />
                  )}
                </Paper>
              </Grid>

              <Grid item xs={12}>
                <Typography variant="h6" gutterBottom>üï∏Ô∏è ÌÇ§ÏõåÎìú Í¥ÄÍ≥Ñ ÎÑ§Ìä∏ÏõåÌÅ¨</Typography>
                <Paper sx={{ p: 2, height: 500 }}>
                  <KeywordNetworkContainer />
                </Paper>
              </Grid>
            </Grid>
          )}
        </TabPanel>

        {/* ÏõåÎìúÌÅ¥ÎùºÏö∞Îìú ÌÉ≠ */}
        <TabPanel value={tabValue} index={2}>
          <Typography variant="h5" gutterBottom>‚òÅÔ∏è ÏõåÎìúÌÅ¥ÎùºÏö∞Îìú</Typography>
          
          {keywordStats.length === 0 ? (
            <Alert severity="info">ÏõåÎìúÌÅ¥ÎùºÏö∞ÎìúÎ•º ÏÉùÏÑ±Ìï† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</Alert>
          ) : (
            <Paper sx={{ p: 2, height: 600 }}>
              <KeywordCloud keywords={keywordStats} />
            </Paper>
          )}
        </TabPanel>

        {/* Ï¶êÍ≤®Ï∞æÍ∏∞ ÌÉ≠ */}
        <TabPanel value={tabValue} index={3}>
          <Typography variant="h5" gutterBottom>‚≠ê Ï¶êÍ≤®Ï∞æÍ∏∞</Typography>
          
          {(() => {
            const favorites = articles.filter(a => a.is_favorite);
            return favorites.length === 0 ? (
              <Alert severity="info">Ï¶êÍ≤®Ï∞æÍ∏∞Ìïú Îâ¥Ïä§Í∞Ä ÏóÜÏäµÎãàÎã§.</Alert>
            ) : (
              <>
                <Typography variant="body1" sx={{ mb: 2, fontWeight: 'bold' }}>
                  **Ï¥ù {favorites.length}Í±¥Ïùò Ï¶êÍ≤®Ï∞æÍ∏∞**
                </Typography>
                {favorites.map(article => (
                  <ArticleCard
                    key={article.id}
                    article={article}
                    onToggleFavorite={handleToggleFavorite}
                    onExtractKeywords={handleExtractKeywords}
                    onTranslate={handleTranslate}
                  />
                ))}
              </>
            );
          })()}
        </TabPanel>

        {/* ÌÖåÎßà/Ïª¨Îü¨ ÌåîÎ†àÌä∏ ÌÉ≠ */}
        <TabPanel value={tabValue} index={4}>
          <Typography variant="h5" gutterBottom>üé® ÌÖåÎßà & Ïª¨Îü¨ ÌåîÎ†àÌä∏</Typography>
          <ColorPalette />
        </TabPanel>
      </Box>
      </ThemeProvider>
    </ThemeContext.Provider>
  );
}